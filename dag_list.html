<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作流控制台 - V13.0 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .trend-bar { transition: height 0.3s, opacity 0.2s; }
        .trend-bar:hover { opacity: 0.8; }
        .badge { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-success { background: #dcfce7; color: #15803d; }
        .badge-fail { background: #fee2e2; color: #b91c1c; }
        .badge-running { background: #dbeafe; color: #1d4ed8; }
        .badge-pending { background: #f1f5f9; color: #64748b; }
        
        /* 模态框动画 */
        .modal-enter { opacity: 0; transform: scale(0.95); pointer-events: none; transition: all 0.2s; }
        .modal-active { opacity: 1; transform: scale(1); pointer-events: auto; }
    </style>
</head>
<body class="text-slate-800">
    <div>
        <nav class="bg-white text-slate-800 h-16 flex items-center justify-between px-8 shadow-sm border-b border-slate-200 sticky top-0 z-30">
            <div class="flex items-center gap-4 text-sm">
                <a href="resource_manage.html" class="text-slate-600 hover:text-slate-800"><i class="fas fa-folder-open mr-1"></i> 资源配置</a>
        </div>
            <div class="flex gap-4 text-sm text-slate-600">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> 调度中心正常</div>
            </div>
        </nav>

        <div class="w-full px-8 py-8">
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">任务计划列表</h2>
                <p class="text-slate-500 text-sm mt-1">管理所有任务计划的调度与执行</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <input id="search-input" type="text" placeholder="搜索任务名称/描述" class="pl-9 pr-3 py-2 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-blue-500 w-60">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <button onclick="batchStart()" class="px-3 py-2 rounded border border-slate-300 hover:bg-blue-50 text-blue-600">批量启动</button>
                    <button onclick="batchStop()" class="px-3 py-2 rounded border border-slate-300 hover:bg-amber-50 text-amber-600">批量停止</button>
                    <button onclick="batchDelete()" class="px-3 py-2 rounded border border-slate-300 hover:bg-red-50 text-red-600">批量删除</button>
                </div>
                <button onclick="createNew()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-lg shadow-blue-600/20 text-sm font-medium flex items-center gap-2 transition transform hover:-translate-y-0.5">
                    <i class="fas fa-plus"></i> 新建工作流
                </button>
            </div>
        </div>

        <div id="content-container" class="min-h-[300px]"></div>
    </div>

    <!-- 新建工作流弹窗 -->
    <div id="create-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeCreateModal()"></div>
    <div id="create-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">新建任务计划</h3>
                <button onclick="closeCreateModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 mb-2">任务计划名称</label>
                    <input type="text" id="new-workflow-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" placeholder="请输入任务计划名称">
                </div>
            </div>
            <div class="px-6 py-3 border-t bg-slate-50 flex justify-end gap-3 rounded-b-xl">
                <button onclick="closeCreateModal()" class="px-4 py-2 text-sm rounded border border-slate-300 text-slate-600 hover:bg-slate-50">取消</button>
                <button onclick="confirmCreate()" class="px-4 py-2 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">确认创建</button>
            </div>
        </div>
    </div>

    <div id="monitor-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeMonitor()"></div>
    <div id="monitor-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="font-bold text-lg text-slate-800" id="m-title">任务监控</h3>
                    <div class="text-xs text-slate-500 font-mono mt-0.5" id="m-id">ID: --</div>
                </div>
                <button onclick="closeMonitor()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-center">
                        <div class="text-xs text-blue-500 uppercase font-bold mb-1">健康度 (近7天)</div>
                        <div class="text-3xl font-bold text-slate-800" id="m-rate">--%</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">平均耗时</div>
                        <div class="text-3xl font-bold text-slate-800" id="m-duration">--s</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">下次调度</div>
                        <div class="text-xl font-bold text-slate-800 mt-1">19:00:00</div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-slate-700">运行趋势 (近30次)</h4>
                        <div class="flex gap-2 text-xs">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-400 rounded-sm"></span>成功</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-red-400 rounded-sm"></span>失败</span>
                        </div>
                    </div>
                    <div class="h-32 bg-slate-50 border rounded-lg p-4 flex items-end justify-between gap-1" id="m-chart"></div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-3">最近执行记录</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-medium border-b">
                                <tr><th class="px-4 py-2">状态</th><th class="px-4 py-2">时间</th><th class="px-4 py-2">耗时</th></tr>
                            </thead>
                            <tbody class="divide-y text-slate-600" id="m-logs"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 执行历史弹窗 -->
    <div id="history-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeHistory()"></div>
    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-5xl rounded-xl shadow-2xl flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">执行历史</h3>
                <button onclick="closeHistory()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="history-list" class="space-y-3 text-sm text-slate-700 max-h-[70vh] overflow-auto"></div>
            </div>
        </div>
    </div>

    <!-- 调度日历弹窗 -->
    <div id="calendar-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeCalendar()"></div>
    <div id="calendar-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4 hidden">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">调度日历</h3>
                <button onclick="closeCalendar()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 text-sm text-slate-700 overflow-y-auto">
                <div class="grid grid-cols-2 gap-3">
                    <div><span class="font-bold text-slate-800">调度类型：</span><span id="c-type">--</span></div>
                    <div><span class="font-bold text-slate-800">模式：</span><span id="c-mode">--</span></div>
                    <div><span class="font-bold text-slate-800">Cron / 周期：</span><span id="c-cron">--</span></div>
                    <div><span class="font-bold text-slate-800">时间：</span><span id="c-time">--</span></div>
                    <div><span class="font-bold text-slate-800">有效期：</span><span id="c-valid">--</span></div>
                    <div><span class="font-bold text-slate-800">日历：</span><span id="c-calendar">--</span></div>
                </div>
                <div>
                    <div class="font-bold text-slate-800 mb-2">近 30 天调度日历</div>
                    <div id="c-calendar-grid" class="grid grid-cols-7 gap-2 text-xs"></div>
                    <div class="flex items-center gap-3 text-xs text-slate-500 mt-2">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 inline-block bg-blue-500 rounded-sm"></span>计划调度</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 inline-block bg-slate-200 rounded-sm"></span>无调度</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-slate-800 mb-2">未来 7 次调度</div>
                    <div id="c-upcoming" class="text-xs text-slate-700 space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 运行详情弹窗 -->
    <div id="run-detail-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeRunDetail()"></div>
    <div id="run-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-xl rounded-xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">运行详情</h3>
                <button onclick="closeRunDetail()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-3 text-sm text-slate-700 overflow-y-auto">
                <div class="grid grid-cols-2 gap-3">
                    <div><span class="font-bold text-slate-800">任务名称：</span><span id="rd-name">--</span></div>
                    <div><span class="font-bold text-slate-800">运行ID：</span><span id="rd-runid">--</span></div>
                    <div><span class="font-bold text-slate-800">状态：</span><span id="rd-status">--</span></div>
                    <div><span class="font-bold text-slate-800">完成度：</span><span id="rd-progress">--</span></div>
                    <div><span class="font-bold text-slate-800">启动时间：</span><span id="rd-start">--</span></div>
                    <div><span class="font-bold text-slate-800">完成时间：</span><span id="rd-end">--</span></div>
                    <div><span class="font-bold text-slate-800">耗时：</span><span id="rd-duration">--</span></div>
                    <div><span class="font-bold text-slate-800">调度类型：</span><span id="rd-type">--</span></div>
                    <div><span class="font-bold text-slate-800">模式：</span><span id="rd-mode">--</span></div>
                    <div><span class="font-bold text-slate-800">Cron/周期：</span><span id="rd-cron">--</span></div>
                </div>
                <div><span class="font-bold text-slate-800">备注：</span><span id="rd-remark">--</span></div>
            </div>
        </div>
    </div>

    <!-- 异常记录弹窗 -->
    <div id="exception-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeException()"></div>
    <div id="exception-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">异常记录</h3>
                <button onclick="closeException()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="exception-list" class="space-y-3 text-sm text-slate-700"></div>
            </div>
        </div>
    </div>

    <!-- 任务导出弹窗 -->
    <div id="canvas-modal-bg" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity" onclick="closeCanvas()"></div>
    <div id="canvas-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-enter p-4">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-slate-800">任务导出</h3>
                <button onclick="closeCanvas()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-3 text-sm text-slate-700">
                <div class="text-slate-500 text-sm">任务导出信息（可接入真实导出接口或文件下载）：</div>
                <div id="canvas-content" class="border rounded-lg p-4 bg-slate-50 text-slate-700 font-mono text-xs whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== 常量配置 =====
        const STORAGE_KEY = 'ds_workflows_v13';
        const BTN_ACTIVE_CLASS = "px-3 py-1.5 rounded text-sm transition bg-blue-50 text-blue-600 shadow-inner";
        const BTN_INACTIVE_CLASS = "px-3 py-1.5 rounded text-sm transition text-slate-500 hover:text-slate-700";
        const STATUS_META = {
            running: { badge: 'badge-running', text: '运行中' },
            success: { badge: 'badge-success', text: '运行成功' },
            fail: { badge: 'badge-fail', text: '运行失败' },
            pending: { badge: 'badge-pending', text: '未启动' },
        };
        
        const PAGE_SIZE = 6;
        let currentView = 'list';
        let currentPage = 1;
        let searchKeyword = '';
        let workflowList = [];
        let selectedIds = new Set();
        let lastPageItems = [];

        // ===== 数据管理 =====
        function loadWorkflows() {
            workflowList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]').map(item => ({
                ...item,
                status: item.status || 'pending',
                history: item.history || [],
            }));
            return workflowList;
        }

        function saveWorkflows(list) {
            workflowList = list;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }

        function getFilteredWorkflows() {
            const kw = (searchKeyword || '').trim().toLowerCase();
            if (!kw) return [...workflowList];
            return workflowList.filter(item => {
                const name = (item.name || '').toLowerCase();
                const desc = (item.desc || '').toLowerCase();
                return name.includes(kw) || desc.includes(kw);
            });
        }

        function initData() {
            if (localStorage.getItem(STORAGE_KEY)) return;
            const demos = [
                { 
                    id: 'WF_DEMO_01', 
                    name: '用户画像每日更新', 
                    desc: '从ODS层同步用户行为数据，计算标签', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000 * 7,
                    creator: '张三',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { 
                        type: '定时', 
                        mode: 'cycle', 
                        cycleUnit: 'day',
                        cycleConfig: { time: '02:00', validEnd: new Date(Date.now() + 86400000 * 365).toISOString().split('T')[0] }
                    }
                },
                { 
                    id: 'WF_DEMO_02', 
                    name: '交易风控实时监测', 
                    desc: '实时流处理，监测异常大额交易', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000 * 3,
                    creator: '李四',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { type: '实时' }
                },
                { 
                    id: 'WF_DEMO_03', 
                    name: '订单ETL清洗入仓', 
                    desc: '每日清洗订单明细并入仓，生成宽表', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000 * 2,
                    creator: '王五',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { 
                        type: '定时', 
                        mode: 'cycle', 
                        cycleUnit: 'day',
                        cycleConfig: { time: '03:00', validEnd: new Date(Date.now() + 86400000 * 180).toISOString().split('T')[0] }
                    }
                },
                { 
                    id: 'WF_DEMO_04', 
                    name: '库存同步校准', 
                    desc: '每小时同步并校准库存，生成差异报告', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000,
                    creator: '赵六',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { 
                        type: '定时', 
                        mode: 'cycle', 
                        cycleUnit: 'hour',
                        cycleConfig: { time: '00:30', validEnd: new Date(Date.now() + 86400000 * 90).toISOString().split('T')[0] }
                    }
                },
                { 
                    id: 'WF_DEMO_05', 
                    name: '营销推送实时监控', 
                    desc: '实时消费埋点，监控转化漏斗', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000 * 4,
                    creator: '钱七',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { type: '实时' }
                },
                { 
                    id: 'WF_DEMO_06', 
                    name: '支付风控离线回溯', 
                    desc: '每日离线回溯欺诈交易，产出黑白名单', 
                    lastUpdate: Date.now(),
                    createTime: Date.now() - 86400000 * 5,
                    creator: '孙八',
                    nodes: [],
                    edges: [],
                    status: 'pending',
                    history: [],
                    runScheduleConfig: { 
                        type: '定时Cron', 
                        cron: '0 4 * * *'
                    }
                }
            ];
            saveWorkflows(demos);
        }

        // ===== 统计数据（基于真实状态） =====
        function getStats(item) {
            const status = item.status || 'pending';
            const successHistory = (item.history || []).filter(h => h.status === 'success').length;
            const failHistory = (item.history || []).filter(h => h.status === 'fail').length;
            const total = successHistory + failHistory || 1;
            const rate = Math.round((successHistory / total) * 100);
            const duration = item.lastDuration || 0;
            return { status, rate: isNaN(rate) ? 0 : rate, duration };
        }

        // ===== 视图切换 =====
        function switchView(mode) {
            currentView = mode;
            const btnCard = document.getElementById('btn-card');
            const btnList = document.getElementById('btn-list');
            
            if (mode === 'card') {
                btnCard.className = BTN_ACTIVE_CLASS;
                btnList.className = BTN_INACTIVE_CLASS;
            } else {
                btnCard.className = BTN_INACTIVE_CLASS;
                btnList.className = BTN_ACTIVE_CLASS;
            }
            render();
        }

        // ===== 渲染核心逻辑 =====
        function render() {
            const container = document.getElementById('content-container');
            if (workflowList.length === 0) {
                renderEmpty(container);
            } else {
                renderListView(container);
            }
        }

        function renderEmpty(container) {
            container.innerHTML = `<div class="text-center py-24 border-2 border-dashed border-slate-300 rounded-xl bg-white"><div class="text-slate-300 text-5xl mb-4"><i class="fas fa-box-open"></i></div><p class="text-slate-500">暂无工作流，点击右上角新建</p></div>`;
        }

        function renderCardView(container) {
            container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            container.innerHTML = '';
            workflowList.forEach(item => {
                const stats = getStats(item);
                const card = createCardElement(item, stats);
                container.appendChild(card);
            });
        }

        function createCardElement(item, stats) {
            const badgeClass = STATUS_META[stats.status]?.badge || 'badge-pending';
            const icon = stats.status === 'success' ? 'fa-check' : stats.status === 'running' ? 'fa-spinner' : 'fa-times';
            
            const div = document.createElement('div');
            div.className = "bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg transition p-0 flex flex-col group overflow-hidden";
            div.innerHTML = `
                <div class="p-5 flex-1">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition truncate w-48" title="${item.name}">${item.name}</h3>
                        <span class="badge ${badgeClass}"><i class="fas ${icon}"></i> ${STATUS_META[stats.status]?.text || '未启动'}</span>
                    </div>
                    <p class="text-slate-500 text-sm h-10 line-clamp-2 mb-4">${item.desc || '暂无描述'}</p>
                    <div class="bg-slate-50 rounded-lg p-3 grid grid-cols-2 gap-4 border border-slate-100">
                        <div><div class="text-xs text-slate-400">成功率</div><div class="font-bold text-slate-700">${stats.rate}%</div></div>
                        <div><div class="text-xs text-slate-400">平均耗时</div><div class="font-bold text-slate-700">${stats.duration}s</div></div>
                    </div>
                </div>
                <div class="bg-slate-50 px-5 py-3 border-t border-slate-100 flex justify-between items-center text-sm">
                    <div class="flex gap-4">
                        <button class="monitor-btn text-slate-500 hover:text-blue-600 font-medium transition" data-id="${item.id}" data-name="${item.name}" data-rate="${stats.rate}"><i class="fas fa-chart-line mr-1"></i>监控</button>
                        <a href="dag_editor.html?id=${item.id}" class="text-slate-500 hover:text-blue-600 font-medium transition"><i class="fas fa-edit mr-1"></i>编辑</a>
                    </div>
                    <button class="delete-btn text-slate-400 hover:text-red-500 transition" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            return div;
        }

        function renderListView(container) {
            container.className = "bg-white rounded-lg border border-slate-200 shadow-sm overflow-x-auto";
            const filtered = getFilteredWorkflows();
            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            currentPage = Math.min(Math.max(1, currentPage), totalPages);
            const start = (currentPage - 1) * PAGE_SIZE;
            const pageItems = filtered.slice(start, start + PAGE_SIZE);
            lastPageItems = pageItems;

            const thead = `<thead class="bg-slate-50 text-slate-500 font-medium text-xs"><tr>
                <th class="px-3 py-3 w-10 text-center"><input id="master-checkbox" type="checkbox" class="master-checkbox w-4 h-4 rounded border-slate-300"></th>
                <th class="px-4 py-3">任务计划名称</th>
                <th class="px-4 py-3">调度类型</th>
                <th class="px-4 py-3">任务数</th>
                <th class="px-4 py-3">创建人</th>
                <th class="px-4 py-3">调度周期</th>
                <th class="px-4 py-3">创建时间</th>
                <th class="px-4 py-3">截止时间</th>
                <th class="px-4 py-3">当前状态</th>
                <th class="px-4 py-3 text-right">操作</th>
            </tr></thead>`;
            const tbody = pageItems.map(item => createTableRow(item, getStats(item))).join('');
            const pagination = `
                <div class="flex justify-between items-center px-4 py-3 text-xs text-slate-600 flex-wrap gap-3">
                    <div>共 ${total} 条，页 ${currentPage}/${totalPages}，每页 ${PAGE_SIZE} 条</div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="page-btn px-2 py-1 border rounded ${currentPage === 1 ? 'text-slate-400 border-slate-200 cursor-not-allowed' : 'hover:bg-slate-50'}" data-page="prev">上一页</button>
                        <div class="flex items-center gap-1">
                            ${buildPageButtons(currentPage, totalPages)}
                        </div>
                        <button class="page-btn px-2 py-1 border rounded ${currentPage === totalPages ? 'text-slate-400 border-slate-200 cursor-not-allowed' : 'hover:bg-slate-50'}" data-page="next">下一页</button>
                        <div class="flex items-center gap-1 ml-2">
                            <span class="text-slate-500">跳转</span>
                            <input id="page-jump" type="number" min="1" max="${totalPages}" value="${currentPage}" class="w-14 px-2 py-1 border rounded text-xs border-slate-300 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = `<table class="w-full text-sm text-left min-w-[1200px]">${thead}<tbody>${tbody}</tbody></table>${pagination}`;
            updateMasterCheckbox();
        }

        function createTableRow(item, stats) {
            const meta = STATUS_META[stats.status] || STATUS_META.pending;
            const badgeClass = meta.badge;
            const statusText = meta.text;
            
            // 获取调度信息
            const scheduleConfig = item.runScheduleConfig || {};
            const scheduleType = scheduleConfig.type || '实时';
            const scheduleCycle = getScheduleCycleText(scheduleConfig);
            const nodeCount = (item.nodes || []).length;
            const creator = item.creator || '系统管理员';
            const createTime = item.createTime ? formatDateTime(item.createTime) : formatDateTime(item.lastUpdate || Date.now());
            const endTime = scheduleConfig.cycleConfig?.validEnd ? formatDate(scheduleConfig.cycleConfig.validEnd) : '永久有效';
            
            return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                    <td class="px-3 py-3 text-center"><input type="checkbox" class="row-checkbox w-4 h-4 rounded border-slate-300" data-id="${item.id}" ${selectedIds.has(item.id) ? 'checked' : ''}></td>
                    <td class="px-4 py-3 font-bold text-slate-700 hover:text-blue-600 cursor-pointer" onclick="viewWorkflow('${item.id}')" title="${item.name}">${item.name}</td>
                    <td class="px-4 py-3 text-xs text-slate-600">${scheduleType}</td>
                    <td class="px-4 py-3 text-xs text-slate-600">${nodeCount}</td>
                    <td class="px-4 py-3 text-xs text-slate-600">${creator}</td>
                    <td class="px-4 py-3 text-xs text-slate-600">${scheduleCycle}</td>
                    <td class="px-4 py-3 text-xs text-slate-500">${createTime}</td>
                    <td class="px-4 py-3 text-xs text-slate-500">${endTime}</td>
                    <td class="px-4 py-3"><span class="badge ${badgeClass}">${statusText}</span></td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex items-center justify-end gap-2 flex-wrap">
                            <button class="action-btn text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded hover:bg-blue-50" data-action="view" data-id="${item.id}" title="查看">查看</button>
                            ${stats.status === 'running' 
                                ? `<button class="action-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50" data-action="stop" data-id="${item.id}" title="停止">停止</button>`
                                : `<button class="action-btn text-green-600 hover:text-green-800 text-xs px-2 py-1 rounded hover:bg-green-50" data-action="start" data-id="${item.id}" title="启动">启动</button>`
                            }
                            <button class="action-btn text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded hover:bg-blue-50" data-action="edit" data-id="${item.id}" title="编辑">编辑</button>
                            <button class="action-btn text-purple-600 hover:text-purple-800 text-xs px-2 py-1 rounded hover:bg-purple-50" data-action="copy" data-id="${item.id}" title="复制">复制</button>
                            <button class="action-btn text-orange-600 hover:text-orange-800 text-xs px-2 py-1 rounded hover:bg-orange-50" data-action="history" data-id="${item.id}" title="执行历史">执行历史</button>
                            <button class="action-btn text-indigo-600 hover:text-indigo-800 text-xs px-2 py-1 rounded hover:bg-indigo-50" data-action="calendar" data-id="${item.id}" title="调度日历">调度日历</button>
                            <button class="action-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50" data-action="delete" data-id="${item.id}" title="删除">删除</button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function getScheduleCycleText(config) {
            if (!config || config.type === '实时') return '实时执行';
            if (config.type === '定时Cron') {
                return config.cron || 'Cron表达式';
            }
            if (config.mode === 'once') {
                return '一次性任务';
            }
            if (config.mode === 'cycle') {
                const unit = config.cycleUnit || 'minute';
                const unitMap = { minute: '分钟', hour: '小时', day: '每天', week: '每周', month: '每月' };
                return `周期任务(${unitMap[unit] || unit})`;
            }
            return '未设置';
        }

        function goPage(page) {
            const filtered = getFilteredWorkflows();
            const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
            currentPage = Math.min(Math.max(1, page), totalPages);
            render();
        }

        function buildPageButtons(current, total) {
            const pages = [];
            if (total <= 7) {
                for (let i = 1; i <= total; i++) pages.push(i);
            } else {
                pages.push(1);
                const start = Math.max(2, current - 1);
                const end = Math.min(total - 1, current + 1);
                if (start > 2) pages.push('...');
                for (let i = start; i <= end; i++) pages.push(i);
                if (end < total - 1) pages.push('...');
                pages.push(total);
            }
            return pages.map(p => {
                if (p === '...') return `<span class="px-2 text-slate-400">...</span>`;
                const active = p === current;
                return `<button class="page-num px-2 py-1 border rounded ${active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'hover:bg-slate-50'}" data-page-num="${p}">${p}</button>`;
            }).join('');
        }

        function toggleSelect(id, checked) {
            if (checked) selectedIds.add(id);
            else selectedIds.delete(id);
            updateMasterCheckbox();
        }

        function toggleSelectAll(checked) {
            lastPageItems.forEach(item => {
                if (checked) selectedIds.add(item.id);
                else selectedIds.delete(item.id);
            });
            render();
        }

        function updateMasterCheckbox() {
            const master = document.getElementById('master-checkbox');
            if (!master) return;
            const pageIds = lastPageItems.map(i => i.id);
            const allSelected = pageIds.length > 0 && pageIds.every(id => selectedIds.has(id));
            const anySelected = pageIds.some(id => selectedIds.has(id));
            master.checked = allSelected;
            master.indeterminate = !allSelected && anySelected;
        }

        function batchStart() {
            if (selectedIds.size === 0) return alert('请先选择任务');
            if (!confirm('确定批量启动选中的任务吗？')) return;
            [...selectedIds].forEach(id => startWorkflowSilent(id));
            render();
        }

        function batchStop() {
            if (selectedIds.size === 0) return alert('请先选择任务');
            if (!confirm('确定批量停止选中的任务吗？')) return;
            [...selectedIds].forEach(id => stopWorkflowSilent(id));
            render();
        }

        function batchDelete() {
            if (selectedIds.size === 0) return alert('请先选择任务');
            if (!confirm('确定批量删除选中的任务吗？')) return;
            [...selectedIds].forEach(id => deleteWfSilent(id));
            render();
        }
        
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDateTimeStr(str) {
            if (!str) return '--';
            return formatDateTime(str);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '永久有效';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        // ===== 业务操作 =====
        function createNew() {
            const modal = document.getElementById('create-modal');
            const bg = document.getElementById('create-modal-bg');
            document.getElementById('new-workflow-name').value = '';
            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }
        
        function closeCreateModal() {
            const modal = document.getElementById('create-modal');
            const bg = document.getElementById('create-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }
        
        function confirmCreate() {
            const nameInput = document.getElementById('new-workflow-name');
            const name = nameInput.value.trim();
            if (!name) {
                alert('请输入任务计划名称');
                nameInput.focus();
                return;
            }
            const list = loadWorkflows();
            const newId = 'WF_' + Date.now().toString().slice(-6);
            list.push({ 
                id: newId, 
                name: name, 
                desc: '', 
                nodes: [], 
                edges: [],
                creator: '当前用户',
                createTime: Date.now(),
                runScheduleConfig: { type: '实时' }
            });
            saveWorkflows(list);
            closeCreateModal();
            render();
            // 自动跳转到编辑页面
            setTimeout(() => {
                location.href = `dag_editor.html?id=${newId}`;
            }, 100);
        }
        
        function viewWorkflow(id) {
            location.href = `dag_editor.html?id=${id}`;
        }
        
        function startWorkflow(id) {
            if (!confirm('确定要启动该任务计划吗？')) return;
            startWorkflowSilent(id);
        }

        function startWorkflowSilent(id) {
                const list = loadWorkflows();
                const item = list.find(w => w.id === id);
            if (!item) return;
            const runId = 'run_' + Date.now();
            const startTime = new Date().toISOString();
                    item.status = 'running';
            item.lastDuration = 0;
            appendHistory(item, 'running', '已提交调度', { runId, startTime, progress: 0, name: item.name });
                    saveWorkflows(list);
                    render();

            // 模拟执行完成回调
            setTimeout(() => {
                const refreshed = loadWorkflows();
                const target = refreshed.find(w => w.id === id);
                if (!target || target.status !== 'running') return;
                const success = Math.random() > 0.2;
                target.status = success ? 'success' : 'fail';
                target.lastDuration = Math.floor(Math.random() * 180) + 20;
                updateHistoryRun(target, runId, {
                    status: target.status,
                    endTime: new Date().toISOString(),
                    progress: success ? 100 : 0,
                    remark: success ? '执行完成' : '执行失败',
                    duration: target.lastDuration
                });
                appendHistory(target, target.status, success ? '执行完成' : '执行失败', { runId, progress: success ? 100 : 0, name: target.name, endTime: new Date().toISOString() });
                saveWorkflows(refreshed);
                render();
            }, 1500 + Math.random() * 1500);
        }

        function stopWorkflow(id) {
            if (!confirm('确定要停止正在运行的任务吗？')) return;
            stopWorkflowSilent(id);
        }

        function stopWorkflowSilent(id) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === id);
            if (!item) return;
            item.status = 'pending';
            appendHistory(item, 'pending', '人工停止', { endTime: new Date().toISOString(), progress: 0, name: item.name });
            saveWorkflows(list);
            render();
        }

        function appendHistory(item, status, remark, extra = {}) {
            item.history = item.history || [];
            item.history.unshift({
                status,
                time: extra.startTime || new Date().toISOString(),
                endTime: extra.endTime || '',
                remark: remark || extra.remark || '',
                duration: extra.duration || item.lastDuration || 0,
                runId: extra.runId || ('run_' + Date.now()),
                progress: typeof extra.progress === 'number' ? extra.progress : 0,
                name: extra.name || item.name || '任务',
            });
            item.history = item.history.slice(0, 10); // 仅保留最近 10 条
        }

        function updateHistoryRun(item, runId, updates = {}) {
            if (!item.history) return;
            const h = item.history.find(x => x.runId === runId);
            if (!h) return;
            Object.assign(h, updates);
        }
        
        function editWorkflow(id) {
            location.href = `dag_editor.html?id=${id}`;
        }
        
        function copyWorkflow(id) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === id);
            if (!item) return;
            
            const newId = 'WF_' + Date.now().toString().slice(-6);
            const copied = {
                ...item,
                id: newId,
                name: item.name + ' (副本)',
                createTime: Date.now(),
                creator: '当前用户'
            };
            list.push(copied);
            saveWorkflows(list);
            render();
            alert('复制成功！');
        }
        
        function showHistory(id) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === id);
            if (!item) return;
            const container = document.getElementById('history-list');
            const history = item.history || [];
            if (history.length === 0) {
                container.innerHTML = `<div class="text-slate-500 text-sm">暂无历史记录</div>`;
            } else {
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left min-w-[800px]">
                            <thead class="bg-slate-50 text-slate-500 font-medium border-b">
                                <tr>
                                    <th class="px-3 py-2">任务名称</th>
                                    <th class="px-3 py-2">运行状态</th>
                                    <th class="px-3 py-2">完成度</th>
                                    <th class="px-3 py-2">启动时间</th>
                                    <th class="px-3 py-2">完成时间</th>
                                    <th class="px-3 py-2 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y text-slate-700">
                                ${history.map(h => {
                                    const meta = STATUS_META[h.status] || STATUS_META.pending;
                                    const progress = typeof h.progress === 'number' ? `${h.progress}%` : '--';
                                    return `<tr>
                                        <td class="px-3 py-2">${h.name || item.name}</td>
                                        <td class="px-3 py-2"><span class="badge ${meta.badge}">${meta.text}</span></td>
                                        <td class="px-3 py-2">${progress}</td>
                                        <td class="px-3 py-2 text-xs text-slate-500">${formatDateTimeStr(h.time)}</td>
                                        <td class="px-3 py-2 text-xs text-slate-500">${formatDateTimeStr(h.endTime)}</td>
                                        <td class="px-3 py-2">
                                            <div class="flex items-center justify-end gap-2 flex-wrap text-xs">
                                                <button class="action-btn text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50" onclick="viewRunDetail('${h.runId}', '${id}')">运行详情</button>
                                                <button class="action-btn text-red-500 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50" onclick="viewException('${h.runId}', '${id}')">异常记录</button>
                                                <button class="action-btn text-indigo-600 hover:text-indigo-800 px-2 py-1 rounded hover:bg-indigo-50" onclick="viewExport('${h.runId}', '${id}')">任务导出</button>
                                                <button class="action-btn text-green-600 hover:text-green-800 px-2 py-1 rounded hover:bg-green-50" onclick="retryRun('${id}', '${h.runId}')">重试</button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            const modal = document.getElementById('history-modal');
            const bg = document.getElementById('history-modal-bg');
            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }
        
        function showCalendar(id) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === id);
            if (!item) return;
            
            const config = item.runScheduleConfig || {};
            const calendar = config.cycleConfig?.calendar || '默认日历';
            const customCalendar = config.cycleConfig?.customCalendar || '';
            
            document.getElementById('c-type').innerText = config.type || '实时';
            document.getElementById('c-mode').innerText = config.mode || '实时';
            document.getElementById('c-cron').innerText = config.cron || (config.mode === 'cycle' ? config.cycleUnit || '--' : '--');
            document.getElementById('c-time').innerText = config.cycleConfig?.time || '--';
            document.getElementById('c-valid').innerText = config.cycleConfig?.validEnd || '永久有效';
            document.getElementById('c-calendar').innerText = calendar === 'custom' && customCalendar ? `自定义(${customCalendar})` : calendar;

            renderCalendarGrid(config);
            renderUpcoming(config);

            const modal = document.getElementById('calendar-modal');
            const bg = document.getElementById('calendar-modal-bg');
            bg.classList.remove('hidden');
            modal.classList.remove('hidden');
            modal.classList.add('modal-enter');
            requestAnimationFrame(() => modal.classList.add('modal-active'));
        }

        function renderCalendarGrid(config) {
            const grid = document.getElementById('c-calendar-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);
            const days = 30;
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < days; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const label = `${d.getMonth() + 1}/${d.getDate()}`;
                const scheduled = isScheduled(d, config);
                const div = document.createElement('div');
                div.className = `border rounded-lg p-2 text-center ${scheduled ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-600'} min-h-[48px] flex flex-col justify-center`;
                div.innerHTML = `<div class="font-semibold">${label}</div><div class="text-[10px]">${scheduled ? (config.cycleConfig?.time || '--') : '—'}</div>`;
                fragment.appendChild(div);
            }
            grid.appendChild(fragment);
        }

        function renderUpcoming(config) {
            const list = document.getElementById('c-upcoming');
            if (!list) return;
            const items = [];
            const now = new Date();
            let d = new Date();
            d.setHours(0,0,0,0);
            while (items.length < 7) {
                if (isScheduled(d, config)) {
                    const t = config.cycleConfig?.time || '00:00';
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${t}`;
                    if (new Date(dateStr) >= now) {
                        items.push(dateStr);
                    }
                }
                d.setDate(d.getDate() + 1);
                if (items.length > 14) break;
            }
            if (items.length === 0) {
                list.innerHTML = `<div class="text-slate-500">暂无未来调度</div>`;
            } else {
                list.innerHTML = items.map(t => `<div class="flex items-center gap-2"><span class="w-2 h-2 bg-blue-500 rounded-full"></span><span>${t}</span></div>`).join('');
            }
        }

        function isScheduled(dateObj, config) {
            if (!config) return false;
            if (config.type === '实时') return false;
            if (config.type === '定时Cron' && config.cron) return true; // 简化处理
            if (config.mode === 'once') return false;
            if (config.mode === 'cycle') {
                const unit = config.cycleUnit || 'day';
                const validEnd = config.cycleConfig?.validEnd ? new Date(config.cycleConfig.validEnd) : null;
                if (validEnd && dateObj > validEnd) return false;
                if (unit === 'day') return true;
                if (unit === 'week') return dateObj.getDay() === (config.cycleConfig?.weekDay ?? 1);
                if (unit === 'month') return dateObj.getDate() === (config.cycleConfig?.monthDay ?? 1);
                if (unit === 'hour' || unit === 'minute') return true;
            }
            return false;
        }

        function deleteWf(id) {
            if (confirm("确定删除吗？")) {
                deleteWfSilent(id);
            }
        }

        function deleteWfSilent(id) {
                const list = loadWorkflows().filter(i => i.id !== id);
                saveWorkflows(list);
            selectedIds.delete(id);
                render();
        }

        // ===== 监控面板 =====
        function openMonitor(id, name, rate) {
            const modal = document.getElementById('monitor-modal');
            const bg = document.getElementById('monitor-modal-bg');
            
            document.getElementById('m-title').innerText = name;
            document.getElementById('m-id').innerText = 'ID: ' + id;
            document.getElementById('m-rate').innerText = rate + "%";
            document.getElementById('m-duration').innerText = Math.floor(Math.random() * 200 + 50) + "s";

            renderChart();
            renderLogs();

            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }

        function renderChart() {
            const chart = document.getElementById('m-chart');
            chart.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < 30; i++) {
                const h = Math.random() * 80 + 20;
                const isFail = Math.random() > 0.9;
                const bar = document.createElement('div');
                bar.className = `trend-bar w-2 rounded-t-sm ${isFail ? 'bg-red-400' : 'bg-blue-400'}`;
                bar.style.height = h + '%';
                fragment.appendChild(bar);
            }
            chart.appendChild(fragment);
        }

        function renderLogs() {
            const logs = document.getElementById('m-logs');
            logs.innerHTML = Array.from({ length: 5 }, (_, i) => {
                const success = Math.random() > 0.2;
                const badgeClass = success ? 'badge-success' : 'badge-fail';
                const status = success ? 'SUCCESS' : 'FAIL';
                const time = new Date(Date.now() - i * 3600000).toLocaleTimeString();
                const duration = (Math.random() * 100).toFixed(1);
                return `<tr><td class="px-4 py-2"><span class="badge ${badgeClass}">${status}</span></td><td class="px-4 py-2 text-xs text-slate-500">${time}</td><td class="px-4 py-2 text-xs font-mono">${duration}s</td></tr>`;
            }).join('');
        }

        function closeMonitor() {
            const modal = document.getElementById('monitor-modal');
            const bg = document.getElementById('monitor-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function closeHistory() {
            const modal = document.getElementById('history-modal');
            const bg = document.getElementById('history-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function closeCalendar() {
            const modal = document.getElementById('calendar-modal');
            const bg = document.getElementById('calendar-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => {
                bg.classList.add('hidden');
                modal.classList.add('hidden');
            }, 200);
        }

        function closeRunDetail() {
            const modal = document.getElementById('run-detail-modal');
            const bg = document.getElementById('run-detail-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function closeException() {
            const modal = document.getElementById('exception-modal');
            const bg = document.getElementById('exception-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function closeCanvas() {
            const modal = document.getElementById('canvas-modal');
            const bg = document.getElementById('canvas-modal-bg');
            modal.classList.remove('modal-active');
            setTimeout(() => bg.classList.add('hidden'), 200);
        }

        function viewRunDetail(runId, workflowId) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === workflowId);
            if (!item) return;
            const history = item.history || [];
            const h = history.find(x => x.runId === runId);
            if (!h) return;
            const meta = STATUS_META[h.status] || STATUS_META.pending;
            document.getElementById('rd-name').innerText = h.name || item.name || '--';
            document.getElementById('rd-runid').innerText = runId;
            document.getElementById('rd-status').innerHTML = `<span class="badge ${meta.badge}">${meta.text}</span>`;
            document.getElementById('rd-progress').innerText = typeof h.progress === 'number' ? `${h.progress}%` : '--';
            document.getElementById('rd-start').innerText = formatDateTimeStr(h.time);
            document.getElementById('rd-end').innerText = formatDateTimeStr(h.endTime);
            document.getElementById('rd-duration').innerText = (h.duration || 0) + 's';
            const cfg = item.runScheduleConfig || {};
            document.getElementById('rd-type').innerText = cfg.type || '实时';
            document.getElementById('rd-mode').innerText = cfg.mode || '实时';
            document.getElementById('rd-cron').innerText = cfg.cron || (cfg.mode === 'cycle' ? (cfg.cycleUnit || '--') : '--');
            document.getElementById('rd-remark').innerText = h.remark || '—';
            const modal = document.getElementById('run-detail-modal');
            const bg = document.getElementById('run-detail-modal-bg');
            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }

        function viewException(runId, workflowId) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === workflowId);
            if (!item) return;
            const history = item.history || [];
            const h = history.find(x => x.runId === runId);
            const container = document.getElementById('exception-list');
            if (!h) {
                container.innerHTML = `<div class="text-slate-500 text-sm">暂无异常</div>`;
            } else {
                const fakeLogs = Array.from({ length: 3 }, (_, i) => ({
                    time: new Date(Date.now() - i * 60000).toLocaleString('zh-CN'),
                    level: i === 0 ? 'ERROR' : 'WARN',
                    msg: i === 0 ? '节点执行失败，退出码 1' : '重试等待中'
                }));
                container.innerHTML = fakeLogs.map(log => `
                    <div class="border rounded-lg p-3 bg-slate-50">
                        <div class="text-xs text-slate-500">${log.time}</div>
                        <div class="font-semibold ${log.level === 'ERROR' ? 'text-red-600' : 'text-amber-600'}">${log.level}</div>
                        <div class="text-sm text-slate-700 mt-1">${log.msg}</div>
                    </div>
                `).join('');
            }
            const modal = document.getElementById('exception-modal');
            const bg = document.getElementById('exception-modal-bg');
            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }

        function viewExport(runId, workflowId) {
            const list = loadWorkflows();
            const item = list.find(w => w.id === workflowId);
            const h = (item?.history || []).find(x => x.runId === runId);
            const content = document.getElementById('canvas-content');
            const name = h?.name || item?.name || '任务';
            content.innerText = `任务：${name}\\n运行ID：${runId}\\n状态：${STATUS_META[h?.status || 'pending']?.text || '未启动'}\\n\\n导出说明：\\n- 可触发真实导出接口，返回下载链接或文件。\\n- 示例：/api/export/${runId}.zip\\n- 可附带导出参数、版本号、生成时间等。\\n\\n（当前为占位展示，可接入真实导出逻辑）`;
            const modal = document.getElementById('canvas-modal');
            const bg = document.getElementById('canvas-modal-bg');
            bg.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }

        function retryRun(workflowId, runId) {
            if (confirm('确定要重试该任务吗？')) {
                startWorkflow(workflowId);
            }
        }

        // ===== 事件代理 =====
        function setupEventDelegation() {
            document.getElementById('content-container').addEventListener('click', (e) => {
                if (e.target.closest('.monitor-btn')) {
                    const btn = e.target.closest('.monitor-btn');
                    openMonitor(btn.dataset.id, btn.dataset.name, btn.dataset.rate);
                } else if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    deleteWf(btn.dataset.id);
                } else if (e.target.closest('.page-btn')) {
                    const btn = e.target.closest('.page-btn');
                    const dir = btn.dataset.page;
                    if (dir === 'prev') goPage(currentPage - 1);
                    if (dir === 'next') goPage(currentPage + 1);
                } else if (e.target.closest('.page-num')) {
                    const btn = e.target.closest('.page-num');
                    const num = parseInt(btn.dataset.pageNum, 10);
                    if (!isNaN(num)) goPage(num);
                } else if (e.target.closest('.row-checkbox')) {
                    const cb = e.target.closest('.row-checkbox');
                    toggleSelect(cb.dataset.id, cb.checked);
                } else if (e.target.closest('.master-checkbox')) {
                    const cb = e.target.closest('.master-checkbox');
                    toggleSelectAll(cb.checked);
                } else if (e.target.closest('.action-btn')) {
                    const btn = e.target.closest('.action-btn');
                    const action = btn.dataset.action;
                    const id = btn.dataset.id;
                    
                    switch(action) {
                        case 'view':
                            viewWorkflow(id);
                            break;
                        case 'start':
                            startWorkflow(id);
                            break;
                        case 'stop':
                            stopWorkflow(id);
                            break;
                        case 'edit':
                            editWorkflow(id);
                            break;
                        case 'copy':
                            copyWorkflow(id);
                            break;
                        case 'history':
                            showHistory(id);
                            break;
                        case 'calendar':
                            showCalendar(id);
                            break;
                        case 'delete':
                            deleteWf(id);
                            break;
                    }
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.target && e.target.id === 'page-jump' && e.key === 'Enter') {
                const val = parseInt(e.target.value, 10);
                if (!isNaN(val)) {
                    goPage(val);
                }
            }
        });

        // ===== 初始化 =====
        initData();
        loadWorkflows();
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchKeyword = e.target.value || '';
                currentPage = 1;
                render();
            });
        }
        render();
        setupEventDelegation();
        updateMasterCheckbox();
    </script>
    </div>
</body>
</html>